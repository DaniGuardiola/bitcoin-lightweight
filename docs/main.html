<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="main.html">
                  main.js
                </a>
              
                
                <a class="source" href="quick-testing.html">
                  quick-testing.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> WALLET_TYPES = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dictionaries/wallet-types'</span>)

<span class="hljs-keyword">const</span> createWallet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/create-wallet'</span>)
<span class="hljs-keyword">const</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">const</span> Joi = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/joi'</span>)
<span class="hljs-keyword">const</span> Electrum = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electrum-client'</span>)

<span class="hljs-keyword">const</span> bip39 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bip39'</span>)
<span class="hljs-keyword">const</span> bitcoin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bitcoinjs-lib'</span>)
<span class="hljs-keyword">const</span> sb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'satoshi-bitcoin'</span>) <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> use bitcoinjs instead</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Promise debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">Promise</span>.config({
  <span class="hljs-attr">longStackTraces</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">monitoring</span>: <span class="hljs-literal">true</span>
})
process.on(<span class="hljs-string">'unhandledRejection'</span>, reason =&gt; <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'\n\n&gt; UNHANDLED PROMISE REJECTION\n\n'</span>, reason, <span class="hljs-string">'\n\n'</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> WALLET_TYPE_LIST = <span class="hljs-built_in">Object</span>.keys(WALLET_TYPES)
<span class="hljs-keyword">const</span> DEFAULT_GAP_LIMIT = <span class="hljs-number">20</span>
<span class="hljs-keyword">const</span> CHANGE_GAP_LIMIT = <span class="hljs-number">6</span>
<span class="hljs-keyword">const</span> ADDRESSES_UPDATE_CONCURRENCY = <span class="hljs-number">1</span> <span class="hljs-comment">// 20</span>
<span class="hljs-keyword">const</span> TRANSACTION_RETRIEVAL_CONCURRENCY = <span class="hljs-number">5</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>helpers</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>TODO: change to generic function with all units support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> satoshisToCoins = <span class="hljs-function"><span class="hljs-params">satoshis</span> =&gt;</span> sb.toBitcoin(satoshis)

<span class="hljs-comment">/**
 * Abstracts the logic of wallets, supporting multiple types for multiple currencies.
 *
 * @param {string} type Type of wallet
 * @param {string|object} secret Private information that provides full access to the wallet
 */</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Wallet</span> </span>{
  <span class="hljs-keyword">constructor</span> (typeId, secret, options = {}) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>validate and store wallet type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    typeId = Joi.attempt(typeId, Joi.string().valid(WALLET_TYPE_LIST).required())

    <span class="hljs-keyword">this</span>._type = WALLET_TYPES[typeId]</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>validate and store secret</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._secret = Joi.attempt(secret, <span class="hljs-keyword">this</span>._type.secretSchema)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>validate and store options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options = Joi.attempt(options, Joi.object({
      <span class="hljs-attr">network</span>: Joi.string().valid([<span class="hljs-string">'bitcoin'</span>, <span class="hljs-string">'testnet'</span>]).default(<span class="hljs-string">'bitcoin'</span>),
      <span class="hljs-attr">gapLimit</span>: Joi.number().integer().positive().max(<span class="hljs-number">100</span>).default(DEFAULT_GAP_LIMIT),
      <span class="hljs-attr">__testsDisableNetwork</span>: Joi.bool()
    }))</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>testing options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.__tests = {}
    <span class="hljs-keyword">this</span>._saveTestsOptions(options)

    <span class="hljs-keyword">this</span>._networkName = options.network
    <span class="hljs-keyword">this</span>._network = bitcoin.networks[options.network]
    <span class="hljs-keyword">this</span>._gapLimit = options.gapLimit</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>init electrum client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__tests.disableNetwork) <span class="hljs-keyword">this</span>._electrum = <span class="hljs-keyword">new</span> Electrum(<span class="hljs-number">53012</span>, <span class="hljs-string">'testnet.hsmiths.com'</span>, <span class="hljs-string">'tls'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>init transaction objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._transactions = {}
    <span class="hljs-keyword">this</span>._rawTransactions = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>cache balance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._balance = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>notification events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.alerts = <span class="hljs-keyword">new</span> EventEmitter()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._initialized = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>._initializationPromise = <span class="hljs-keyword">this</span>._initialize()
    <span class="hljs-keyword">this</span>._initializationPromise.then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.alerts.emit(<span class="hljs-string">'ready'</span>))
  }

  _saveTestsOptions (options) {
    <span class="hljs-keyword">this</span>.__tests.disableNetwork = options.__testsDisableNetwork || <span class="hljs-literal">false</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>wallet creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-comment">/**
   * Creates a new wallet
   *
   * @param  {string} type    Wallet type
   * @param  {object} options Options for wallet creation
   * @return {Wallet}         Wallet instance
   */</span>
  <span class="hljs-keyword">static</span> create (type, options = {}) {
    <span class="hljs-keyword">const</span> { secret, <span class="hljs-attr">options</span>: opts } = createWallet[type](options)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Wallet(type, secret, opts)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  _ensureInitialized () {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>throws if wallet is not initialized</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>if not initialized, throw an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._initialized) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Wallet is not initialized yet'</span>)
  }

  <span class="hljs-keyword">async</span> _onInitialized () {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>can be used in async functions by adding: await this._onInitialized()
statements after it will be run only if/once wallet is initialized</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>if not initialized, wait for initialization to be over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._initialized) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._initializationPromise
  }

  _initializeBIP39BIP49Secret () {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>github.com/bitcoin/bips/blob/master/bip-0039.mediawiki</p>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>true =&gt; string (seed) format
false =&gt; object (seed + optional passphrase) format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> stringFormat = <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._secret === <span class="hljs-string">'string'</span>

    <span class="hljs-keyword">const</span> seed = stringFormat
      ? <span class="hljs-keyword">this</span>._secret
      : <span class="hljs-keyword">this</span>._secret.seed
    <span class="hljs-keyword">const</span> passphrase = stringFormat
      ? <span class="hljs-literal">null</span>
      : <span class="hljs-keyword">this</span>._secret.passphrase</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>remove passphrase from context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._secret.passphrase</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>derive and store HD private key from mnemonic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> mnemonic = bip39.mnemonicToSeed(seed, passphrase)
    <span class="hljs-keyword">this</span>._rootHDNode = bitcoin.HDNode.fromSeedBuffer(mnemonic, <span class="hljs-keyword">this</span>._network)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>hd wallet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  _initializeBIP49Secret () {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>github.com/bitcoin/bips/blob/master/bip-0032.mediawiki</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>store HD private key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._rootHDNode = bitcoin.HDNode.fromBase58(<span class="hljs-keyword">this</span>._secret, <span class="hljs-keyword">this</span>._network)
  }

  <span class="hljs-keyword">async</span> _initializeBIP49Wallet () {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>github.com/bitcoin/bips/blob/master/bip-0044.mediawiki</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> BIP49CoinType = <span class="hljs-keyword">this</span>._type.BIP49CoinTypes[<span class="hljs-keyword">this</span>._networkName]</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>get BIP 44 main account, external and change HD keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> mainAccountHDNode = <span class="hljs-keyword">this</span>._rootHDNode.derivePath(<span class="hljs-string">`m/49'/<span class="hljs-subst">${BIP49CoinType}</span>'/0'`</span>)
    <span class="hljs-keyword">this</span>._mainAccountHDNodes = {
      <span class="hljs-attr">external</span>: mainAccountHDNode.derive(<span class="hljs-number">0</span>),
      <span class="hljs-attr">change</span>: mainAccountHDNode.derive(<span class="hljs-number">1</span>)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>generate the initial external and change addresses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._addresses = {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO: DRY this function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      external: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-keyword">this</span>._gapLimit).fill().map(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span> Wallet._deriveBIP49Address(<span class="hljs-keyword">this</span>._deriveHDNode(<span class="hljs-string">'external'</span>, index), <span class="hljs-string">'external'</span>)),
      <span class="hljs-attr">change</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(CHANGE_GAP_LIMIT).fill().map(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span> Wallet._deriveBIP49Address(<span class="hljs-keyword">this</span>._deriveHDNode(<span class="hljs-string">'change'</span>, index), <span class="hljs-string">'change'</span>))
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>subscribe to address updates (if network is not disabled)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__tests.disableNetwork) {
      <span class="hljs-keyword">this</span>._electrum.subscribe.on(<span class="hljs-string">'blockchain.scripthash.subscribe'</span>, <span class="hljs-keyword">async</span> params =&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._updateAddressHistoryById(params[<span class="hljs-number">0</span>])
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._update()
      })
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>run the initial update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._update()
  }

  _deriveHDNode (type, index) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mainAccountHDNodes[type].derive(index)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>addresses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">static</span> _deriveBIP49Address (hdNode, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>derives a P2SH(P2WPKH) address from the relevant HD key for a given index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> keyhash = bitcoin.crypto.hash160(hdNode.getPublicKeyBuffer())
    <span class="hljs-keyword">const</span> scriptSig = bitcoin.script.witnessPubKeyHash.output.encode(keyhash)
    <span class="hljs-keyword">const</span> addressBytes = bitcoin.crypto.hash160(scriptSig)
    <span class="hljs-keyword">const</span> outputScript = bitcoin.script.scriptHash.output.encode(addressBytes)

    <span class="hljs-keyword">const</span> id = bitcoin.address.fromOutputScript(outputScript, <span class="hljs-keyword">this</span>._network)
    <span class="hljs-keyword">const</span> scriptHash = bitcoin.crypto.sha256(outputScript)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>initial address object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> {
      type,
      id,
      scriptHash,
      <span class="hljs-attr">subscribed</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">history</span>: [],
      <span class="hljs-attr">balance</span>: <span class="hljs-number">0</span>
    }
  }

  <span class="hljs-keyword">async</span> _updateAddresses (type, subscribe, fetchAddressHistory) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>update all types of addresses if type is not specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!type || type === <span class="hljs-string">'all'</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.mapSeries([<span class="hljs-string">'external'</span>, <span class="hljs-string">'change'</span>], newType =&gt; <span class="hljs-keyword">this</span>._updateAddresses(newType, subscribe, fetchAddressHistory))</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>take care of not subscribed / outdated addresses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._addresses[type] = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.map(<span class="hljs-keyword">this</span>._addresses[type], <span class="hljs-keyword">async</span> address =&gt; {
      <span class="hljs-keyword">const</span> scriptHashBuffer = Buffer.alloc(address.scriptHash.length)
      address.scriptHash.copy(scriptHashBuffer)
      <span class="hljs-keyword">const</span> scriptHash = scriptHashBuffer.reverse().toString(<span class="hljs-string">'hex'</span>)
      <span class="hljs-keyword">let</span> status
      <span class="hljs-keyword">if</span> (!address.subscribed) {
        status = <span class="hljs-keyword">await</span> subscribe(scriptHash)
        address.subscribed = <span class="hljs-literal">true</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> address <span class="hljs-comment">// if already subscribed, no need to pull history</span>

      <span class="hljs-keyword">if</span> (address.status !== status) <span class="hljs-built_in">Object</span>.assign(address, <span class="hljs-keyword">await</span> fetchAddressHistory(scriptHash))

      <span class="hljs-keyword">return</span> address
    }, { <span class="hljs-attr">concurrency</span>: ADDRESSES_UPDATE_CONCURRENCY })
  }

  _addAddresses (type, amount) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>creates and appends as many addresses as specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> length = <span class="hljs-keyword">this</span>._addresses[type].length
    <span class="hljs-keyword">const</span> newAddresses = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(amount).fill().map(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span>
      Wallet._deriveBIP49Address(<span class="hljs-keyword">this</span>._deriveHDNode(type, index + length), type))
    <span class="hljs-keyword">this</span>._addresses[type] = <span class="hljs-keyword">this</span>._addresses[type].concat(newAddresses)
  }

  _fixAddressGap (type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>returns true if new addresses were added (in which case an update is needed)</p>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>fix for all types of addresses if type is not specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!type) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.map([<span class="hljs-string">'external'</span>, <span class="hljs-string">'change'</span>], type =&gt; <span class="hljs-keyword">this</span>._fixAddressGap(type)).then(<span class="hljs-function"><span class="hljs-params">arr</span> =&gt;</span> arr.some(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r === <span class="hljs-literal">true</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>get gap limit depending on the type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> gapLimit = type === <span class="hljs-string">'external'</span>
      ? <span class="hljs-keyword">this</span>._gapLimit
      : CHANGE_GAP_LIMIT</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>calculate missing addresses (gap size)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> initialIndex = <span class="hljs-keyword">this</span>._addresses[type].length &gt; gapLimit
      ? <span class="hljs-keyword">this</span>._addresses[type].length - gapLimit
      : <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> nMissingAddresses = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>._addresses[type].slice(initialIndex).reverse().some(<span class="hljs-function">(<span class="hljs-params">address, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (address.history.length) {
        nMissingAddresses = gapLimit - i
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      }
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>fill addresses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (nMissingAddresses) {
      <span class="hljs-keyword">this</span>._addAddresses(type, nMissingAddresses)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
  }

  _computeAddressStatus (history) {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>electrumx.readthedocs.io/en/latest/protocol-basics.html#status</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!history.length) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> bitcoin.crypto.sha256(history
      .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (a.height &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> (a.height === b.height) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">return</span> a.height &gt; b.height ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>
      })
      .reduce(<span class="hljs-function">(<span class="hljs-params">out, tx</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${out}</span><span class="hljs-subst">${tx.tx_hash}</span>:<span class="hljs-subst">${tx.height}</span>:`</span>, <span class="hljs-string">''</span>))
  }

  _getAddressLocationFromId (addressId, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>returns the type and index of an address id</p>

            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>if type is specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (type) {
      <span class="hljs-keyword">return</span> {
        type,
        <span class="hljs-attr">index</span>: <span class="hljs-keyword">this</span>._addresses[type].findIndex(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> address.id === addressId)
      }
    }

    <span class="hljs-keyword">let</span> index</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>try ‘external’ type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    type = <span class="hljs-string">'external'</span>
    index = <span class="hljs-keyword">this</span>._getAddressLocationFromId(addressId, type).index

    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// if not found as 'external', try 'change' type</span>
      type = <span class="hljs-string">'change'</span>
      index = <span class="hljs-keyword">this</span>._getAddressLocationFromId(addressId, type).index
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>if not found, return false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

    <span class="hljs-keyword">return</span> { type, index }
  }

  <span class="hljs-keyword">async</span> _updateAddressHistoryById (id, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>updates the history of an address by id (updates local record)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> addressLocation = <span class="hljs-keyword">this</span>._getAddressLocationFromId(id, type)
    <span class="hljs-keyword">const</span> { index } = addressLocation
    type = addressLocation.type

    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._fetchAddressHistory(<span class="hljs-keyword">this</span>._addresses[type][index].id)

    <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">this</span>._addresses[type][index], <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._fetchAddressHistory(<span class="hljs-keyword">this</span>._addresses[type][index].id))
  }

  <span class="hljs-keyword">async</span> _fetchAddressHistory (addressId) {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>retrieves history for an address (does not mutate local record)
then retrieves and stores all transactions’ data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> history = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._electrum.blockchain.scripthash.getHistory(addressId)
    <span class="hljs-keyword">const</span> status = <span class="hljs-keyword">this</span>._computeAddressStatus(history)

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.mapSeries(history,
      tx =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._retrieveTransaction(tx.tx_hash, tx.height)
      },
      { <span class="hljs-attr">concurrency</span>: TRANSACTION_RETRIEVAL_CONCURRENCY })

    <span class="hljs-keyword">return</span> { history, status }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>transaction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">static</span> _parseTransactionIO (inputData, outputData) {
    <span class="hljs-keyword">const</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>inputAddresses,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      inputExternalAddresses,
      inputBalance,
      inputOwnedBalance,
      allInputOwned
    } = inputData

    <span class="hljs-keyword">const</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>outputAddresses,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      outputExternalAddresses,
      outputBalance,
      outputOwnedBalance
    } = outputData

    <span class="hljs-keyword">const</span> change = outputOwnedBalance - inputOwnedBalance

    <span class="hljs-keyword">const</span> direction = change &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'in'</span> : <span class="hljs-string">'out'</span>

    <span class="hljs-keyword">const</span> feeSatoshis = inputBalance - outputBalance <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> detect if fee was paid by this wallet</span>
    <span class="hljs-keyword">const</span> fee = satoshisToCoins(feeSatoshis)
    <span class="hljs-keyword">let</span> feePaidByWallet = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">const</span> totalSatoshis = change
    <span class="hljs-keyword">const</span> total = satoshisToCoins(totalSatoshis)
    <span class="hljs-keyword">let</span> amountSatoshis = <span class="hljs-built_in">Math</span>.abs(totalSatoshis)

    <span class="hljs-keyword">let</span> peers = <span class="hljs-string">'UNKNOWN'</span>

    <span class="hljs-keyword">if</span> (direction === <span class="hljs-string">'in'</span>) {
      <span class="hljs-keyword">if</span> (inputOwnedBalance === <span class="hljs-number">0</span>) {
        peers = inputExternalAddresses
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Type of transaction not covered yet (owned inputs on incoming transaction)'</span>)
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// out</span>
      <span class="hljs-keyword">if</span> (allInputOwned) {
        peers = outputExternalAddresses
        feePaidByWallet = <span class="hljs-literal">true</span>
        amountSatoshis -= feeSatoshis
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Type of transaction not covered yet (external inputs on outgoing transaction)'</span>)
    }

    <span class="hljs-keyword">const</span> amount = satoshisToCoins(amountSatoshis)

    <span class="hljs-keyword">return</span> {
      direction,
      peers,

      total,
      totalSatoshis,

      amount,
      amountSatoshis,

      fee,
      feeSatoshis,
      feePaidByWallet
    }
  }

  <span class="hljs-keyword">static</span> _parseOutputs (outputs, network, getAddressInfo) {
    <span class="hljs-keyword">const</span> outputAddresses = []
    <span class="hljs-keyword">const</span> outputExternalAddresses = []
    <span class="hljs-keyword">let</span> outputBalance = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> outputOwnedBalance = <span class="hljs-number">0</span>

    outputs.forEach(<span class="hljs-function"><span class="hljs-params">output</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> address = bitcoin.address.fromOutputScript(output.script, network)
      <span class="hljs-keyword">const</span> addressInfo = getAddressInfo(address)
      <span class="hljs-keyword">if</span> (addressInfo) outputOwnedBalance += output.value
      <span class="hljs-keyword">else</span> outputExternalAddresses.push(address)
      outputBalance += output.value
      outputAddresses.push(address)
    })

    <span class="hljs-keyword">return</span> {
      outputAddresses,
      outputExternalAddresses,
      outputBalance,
      outputOwnedBalance
    }
  }

  <span class="hljs-keyword">static</span> _parseRawTransaction (hex) {
    <span class="hljs-keyword">return</span> {
      hex,
      <span class="hljs-attr">transaction</span>: bitcoin.Transaction.fromHex(hex)
    }
  }

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> _retrieveAndParseInputs (inputs, network, retrieveRawTransaction, getAddressInfo) {
    <span class="hljs-keyword">const</span> inputAddresses = []
    <span class="hljs-keyword">const</span> inputExternalAddresses = []
    <span class="hljs-keyword">let</span> inputBalance = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> inputOwnedBalance = <span class="hljs-number">0</span>

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.map(inputs, <span class="hljs-keyword">async</span> input =&gt; {
      <span class="hljs-keyword">const</span> { transaction } = <span class="hljs-keyword">await</span> retrieveRawTransaction(input.hash.reverse())
      <span class="hljs-keyword">const</span> originalOutput = transaction.outs[input.index]

      <span class="hljs-keyword">const</span> address = bitcoin.address.fromOutputScript(originalOutput.script, network)
      <span class="hljs-keyword">const</span> addressInfo = getAddressInfo(address)
      <span class="hljs-keyword">if</span> (addressInfo) inputOwnedBalance += originalOutput.value
      <span class="hljs-keyword">else</span> inputExternalAddresses.push(address)
      inputBalance += originalOutput.value
      inputAddresses.push(address)
    })

    <span class="hljs-keyword">const</span> allInputOwned = inputBalance === inputOwnedBalance

    <span class="hljs-keyword">return</span> {
      inputAddresses,
      inputExternalAddresses,
      inputBalance,
      inputOwnedBalance,
      allInputOwned
    }
  }

  <span class="hljs-keyword">async</span> _retrieveRawTransaction (hash) {
    <span class="hljs-keyword">if</span> (hash <span class="hljs-keyword">instanceof</span> Buffer) hash = hash.toString(<span class="hljs-string">'hex'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>use cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._rawTransactions[hash]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._rawTransactions[hash]</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>retrieve</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> hex = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._electrum.blockchain.transaction.get(hash)</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>parse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> tx = Wallet._parseRawTransaction(hex)</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>write cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._rawTransactions[hash] = tx

    <span class="hljs-keyword">return</span> tx
  }

  <span class="hljs-keyword">async</span> _retrieveTransaction (hash, height) {
    <span class="hljs-keyword">if</span> (hash <span class="hljs-keyword">instanceof</span> Buffer) hash = hash.toString(<span class="hljs-string">'hex'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>TODO: handle height change (unconfirmed parents &gt; confirmed parents in mempool &gt; confirmed)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._transactions[hash]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._transactions[hash]

    <span class="hljs-keyword">const</span> { transaction } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._retrieveRawTransaction(hash)

    <span class="hljs-keyword">const</span> { ins, outs } = transaction

    <span class="hljs-keyword">const</span> inputData = <span class="hljs-keyword">await</span> Wallet._retrieveAndParseInputs(ins,
      <span class="hljs-keyword">this</span>._network,
      hash =&gt; <span class="hljs-keyword">this</span>._retrieveRawTransaction(hash),
      address =&gt; <span class="hljs-keyword">this</span>._getAddressLocationFromId(address))
    <span class="hljs-keyword">const</span> outputData = <span class="hljs-keyword">await</span> Wallet._parseOutputs(outs,
      <span class="hljs-keyword">this</span>._network,
      address =&gt; <span class="hljs-keyword">this</span>._getAddressLocationFromId(address))

    <span class="hljs-keyword">const</span> parsedTx = Wallet._parseTransactionIO(inputData, outputData)
    <span class="hljs-keyword">const</span> finalTx = <span class="hljs-built_in">Object</span>.assign({ hash, height }, parsedTx)
    <span class="hljs-keyword">this</span>._transactions[hash] = finalTx

    <span class="hljs-keyword">const</span> previousBalance = <span class="hljs-keyword">this</span>._balance
    <span class="hljs-keyword">this</span>._balance += finalTx.totalSatoshis
    <span class="hljs-keyword">const</span> balanceEvent = {
      <span class="hljs-attr">balance</span>: <span class="hljs-keyword">this</span>._balance,
      <span class="hljs-attr">change</span>: finalTx.totalSatoshis,
      <span class="hljs-attr">previous</span>: previousBalance,
      <span class="hljs-attr">transaction</span>: finalTx.hash
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._initialized) {
      <span class="hljs-keyword">this</span>.alerts.emit(<span class="hljs-string">'transaction'</span>, <span class="hljs-built_in">Object</span>.assign({}, finalTx))
      <span class="hljs-keyword">this</span>.alerts.emit(<span class="hljs-string">'balance'</span>, balanceEvent)
    }

    <span class="hljs-keyword">return</span> finalTx
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>lifecycle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">async</span> _initialize () {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>initialize secret</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ;({
      <span class="hljs-attr">BIP39_BIP49</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>._initializeBIP39BIP49Secret(),
      <span class="hljs-attr">BIP49</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>._initializeBIP49Secret()
    })[<span class="hljs-keyword">this</span>._type.secretType]()</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>connect to electrum</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__tests.disableNetwork) <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._electrum.connect()</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>initialize wallet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">await</span> ({
      <span class="hljs-attr">BIP39_BIP49</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>._initializeBIP49Wallet(),
      <span class="hljs-attr">BIP49</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>._initializeBIP49Wallet()
    })[<span class="hljs-keyword">this</span>._type.secretType]()</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>update initialization-related state props</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._initialized = <span class="hljs-literal">true</span>
  }

  <span class="hljs-keyword">async</span> _update () {
    <span class="hljs-keyword">let</span> subscribe
    <span class="hljs-keyword">let</span> fetchAddressHistory</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>disable network for testing option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.__tests.disableNetwork) {
      subscribe = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-literal">null</span>
      fetchAddressHistory = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> ({ <span class="hljs-attr">history</span>: [], <span class="hljs-attr">status</span>: <span class="hljs-literal">null</span> })
    } <span class="hljs-keyword">else</span> {
      subscribe = <span class="hljs-function"><span class="hljs-params">scriptHash</span> =&gt;</span> <span class="hljs-keyword">this</span>._electrum.blockchain.scripthash.subscribe(scriptHash)
      fetchAddressHistory = <span class="hljs-function"><span class="hljs-params">scriptHash</span> =&gt;</span> <span class="hljs-keyword">this</span>._fetchAddressHistory(scriptHash)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>update all addresses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._updateAddresses(<span class="hljs-string">'all'</span>, subscribe, fetchAddressHistory)</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>check gap and fill it if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> newAddresses = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._fixAddressGap()</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>update again if new addresses were added</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (newAddresses) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._update()
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-comment">/**
   * Resolves once wallet is up-to-date and ready to be used (or immediately if that's already the current state)
   *
   * @async
   * @return {Promise} Resolves only once ready
   */</span>
  <span class="hljs-keyword">async</span> onReady () {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._onInitialized()
  }

  <span class="hljs-comment">/**
   * @return {{
   *   external: array&lt;{id: string, balance: number}&gt;,
   *   change: array&lt;{id: string, balance: number}&gt;
   * }}
   * Addresses and their current balances
   */</span>
  getAddresses () {
    <span class="hljs-keyword">this</span>._ensureInitialized()

    <span class="hljs-keyword">const</span> normalizeAddress = <span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> { id, balance } = address
      <span class="hljs-keyword">return</span> { id, balance }
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">external</span>: <span class="hljs-keyword">this</span>._addresses.external.map(normalizeAddress),
      <span class="hljs-attr">change</span>: <span class="hljs-keyword">this</span>._addresses.change.map(normalizeAddress)
    }
  }

  <span class="hljs-comment">/**
   * Retrieves the current wallet balance and the estimation for the secondary currency
   *
   * @async
   * @param  {object} options Options for the getBalance operation
   * @param  {string} options.unit Unit of measure (`coins` | `satoshis`)
   *
   * @return {Promise&lt;number&gt;} Current balance of the wallet
   */</span>
  getBalance (options = {}) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>TODO: unit option validation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> unit = options.unit || <span class="hljs-string">'coins'</span>

    <span class="hljs-keyword">this</span>._ensureInitialized()
    <span class="hljs-comment">/*
      TODO
      - move complete calc to another function to execute only once
      - cache balance
      - recalculate with every transaction
      - send balance events
    */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>TODO: replace with genertic unit conversion function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (unit === <span class="hljs-string">'satoshis'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._balance
    <span class="hljs-keyword">if</span> (unit === <span class="hljs-string">'coins'</span>) <span class="hljs-keyword">return</span> satoshisToCoins(<span class="hljs-keyword">this</span>._balance)

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown unit '<span class="hljs-subst">${unit}</span>'`</span>)
  }

  <span class="hljs-keyword">async</span> getTransactionHistory (options = {}) {
    <span class="hljs-keyword">this</span>._ensureInitialized()
    <span class="hljs-comment">/*
      Using electrum-client, retrieve all historic transactions with all the data for all of the
      wallet's addresses.

      The history should be stored in the local database and updated everytime new transactions are
      pulled.

      There should be pagination based on either:
      - Number of transaction from the start
      - Id of the last transaction pulled (the most recent or the oldest depending on direction)

      There shouldn't be paagination based on inverse number of transaction because this could cause
      offset problems when a transaction is made inbetween pages.

      This method might include filtering options to facilitate search.

      Additionally, if non-blockchain metadata is stored in owned servers, the appropiate requests should
      be made (with proper cache).

      Also we might want to include the option to let the user store non-blockchain transaction metadata
      locally, so all of this data should be combined properly. We might want to do it in an asynchronous fashion
      to allow for optimal app responsiveness (e. g. displaying pure blockchain tx data first, and then updating
      with additional metadata when ready).

      We might want to split this into different methods or provide a different async interface, as promises only
      fullfill once and that's it, while this would require different stages. Might be worth it to consider the use
      of observables (reactivex.io), streams or similar.

      Formatting options (like returning strings with an appended currency symbol with i18n instead of
      just the numbers) should be included.
    */</span>
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO: user-friendly error messages instead of Joi’s? <a href="https://github.com/hapijs/joi/issues/546">https://github.com/hapijs/joi/issues/546</a></p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
